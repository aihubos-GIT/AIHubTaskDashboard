@using Microsoft.AspNetCore.Http
@{
    // Lấy thông tin người dùng từ Session
    var fullName = Context.Session.GetString("FullName");
    var authToken = Context.Session.GetString("AuthToken");

    // 1. KIỂM TRA ĐĂNG NHẬP
    // Nếu fullName và AuthToken đều thiếu, chuyển hướng đến Login.
    if (string.IsNullOrEmpty(fullName) && string.IsNullOrEmpty(authToken))
    {
        // Chuyển hướng Razor (Bắt buộc phải dùng Response.Redirect hoặc chuyển hướng trong Controller)
        // Lưu ý: Nếu trang hiện tại là /Account/Login, không chuyển hướng để tránh vòng lặp vô tận.
        var currentPath = Context.Request.Path.Value?.ToLower() ?? "";
        if (!currentPath.Contains("/account/login") && !currentPath.Contains("/account/register"))
        {
            Context.Response.Redirect("/Account/Login");
        }
    }
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - AIHub Task Tracker</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/css/site.css" />
</head>
<body>

    @if (!string.IsNullOrEmpty(fullName))
    {
        // === HIỂN THỊ LAYOUT CHỈ KHI ĐÃ ĐĂNG NHẬP ===

        <div class="d-flex" id="wrapper">

            <div class="bg-dark border-end" id="sidebar-wrapper">
                <div class="sidebar-heading">⚡ AIHub OS</div>
                <div class="list-group list-group-flush my-3">
                    <a href="/ManagerTask" class="list-group-item list-group-item-action bg-dark text-white active">
                        <i class="bi bi-speedometer2 me-2"></i> Dashboard
                    </a>
                    <a href="/Tasks/v2" class="list-group-item list-group-item-action bg-dark text-white">
                        <i class="bi bi-list-task me-2"></i> Task của tôi 
                    </a>
                    <a href="/Account/Profile" class="list-group-item list-group-item-action bg-dark text-white">
                        <i class="bi bi-person me-2"></i> Hồ sơ cá nhân
                    </a>
                    <a href="/Settings" class="list-group-item list-group-item-action bg-dark text-white">
                        <i class="bi bi-gear me-2"></i> Cài đặt
                    </a>
                </div>
            </div>
            <div id="page-content-wrapper">

                <header class="header bg-white shadow-sm py-3 px-4 border-bottom">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <button class="btn btn-outline-secondary" id="sidebarToggle">
                            <i class="bi bi-list"></i>
                        </button>

                        <div class="user-info">
                            <div class="dropdown">
                                <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-person-circle me-1"></i> @fullName
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow">
                                    <li><a class="dropdown-item" href="/Account/Profile"><i class="bi bi-person me-2"></i> Hồ sơ cá nhân</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="/Account/Logout"><i class="bi bi-box-arrow-right me-2"></i> Đăng xuất</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </header>

                <main role="main" class="container-fluid py-4 flex-grow-1">
                    @RenderBody()
                </main>

                <footer class="footer p-3 text-center text-muted border-top bg-light">
                    Cập nhật: @DateTime.Now.ToString("dd/MM/yyyy") • © AIHub OS
                </footer>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
                crossorigin="anonymous"></script>

        <script>
            document.getElementById('sidebarToggle').addEventListener('click', function () {
                document.getElementById('wrapper').classList.toggle('toggled');
            });
        </script>
        @RenderSection("Scripts", required: false)
    }
    else
    {
        // NẾU CHƯA ĐĂNG NHẬP, KHÔNG HIỂN THỊ GÌ NGOÀI TRANG LOGIN
        @RenderBody()
    }
</body>
</html>
@using System.Text.Json
@model System.Text.Json.JsonElement

@{
    ViewBag.Title = "Chỉnh sửa Task";
    var usersJson = ViewBag.Users as JsonElement? ?? JsonDocument.Parse("[]").RootElement;
    var users = usersJson.ValueKind == JsonValueKind.Array ? usersJson.EnumerateArray() : Enumerable.Empty<JsonElement>();

    // Đảm bảo dữ liệu tồn tại và trích xuất giá trị an toàn (Dùng "task_id" thay vì "id")
    int taskId = Model.TryGetProperty("task_id", out var id) ? id.GetInt32() : 0;
    string title = Model.TryGetProperty("title", out var t) ? t.GetString() : "";
    string description = Model.TryGetProperty("description", out var d) ? d.GetString() : "";
    string status = Model.TryGetProperty("status", out var st) ? st.GetString() : "";
    int progress = Model.TryGetProperty("progress_percentage", out var p) ? p.GetInt32() : 0;
    string clickupId = Model.TryGetProperty("clickup_id", out var c) ? c.GetString() : "Chưa đồng bộ";
    int currentAssigneeId = Model.TryGetProperty("assignee_id", out var aid) ? aid.GetInt32() : 0;
    int assignerId = Model.TryGetProperty("assigner_id", out var aoid) ? aoid.GetInt32() : 0;
}

<h2 class="fw-bold mb-4">Chỉnh sửa Task #@taskId</h2>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        @* <p class="mb-0 text-muted">ID ClickUp: <span class="fw-semibold">@clickupId</span></p> *@
        <p class="mb-0 text-muted">Người tạo: <span class="fw-semibold">#@assignerId</span></p>
    </div>
</div>

<div class="card shadow-sm profile-card">
    <div class="card-body p-4 p-md-5">

        <form asp-action="Edit" method="post" class="row g-4" asp-route-id="@taskId">

            <div class="col-12">
                <label for="titleInput" class="form-label fw-semibold">Tiêu đề Task <span class="text-danger">*</span></label>
                <input type="text" id="titleInput" name="title" class="form-control" value="@title" required />
            </div>

            <div class="col-12">
                <label for="descriptionInput" class="form-label fw-semibold">Mô tả chi tiết</label>
                <textarea id="descriptionInput" name="description" class="form-control" rows="4">@description</textarea>
            </div>

            <div class="col-md-4">
                <label for="statusInput" class="form-label fw-semibold">Trạng thái</label>
                <select id="statusInput" name="status" class="form-select">
                    @{
                        var taskStatuses = new List<string> { "To Do", "In Progress", "Completed" };
                    }
                    @foreach (var statusOption in taskStatuses)
                    {
                        <option value="@statusOption" selected="@(status == statusOption)">@statusOption</option>
                    }
                </select>
            </div>

            <div class="col-md-4">
                <label for="assigneeInput" class="form-label fw-semibold">Người được giao</label>
                <select id="assigneeInput" name="assignee_id" class="form-select">
                    <option value="">-- Chọn người giao --</option>
                    @foreach (var user in users)
                    {
                        var userId = user.TryGetProperty("id", out var uid) ? uid.GetInt32() : 0;
                        var fullName = user.TryGetProperty("name", out var fn) ? fn.GetString() :
                        (user.TryGetProperty("username", out var un) ? un.GetString() : "Unknown User");

                        if (userId == 0) continue;

                        <option value="@userId" selected="@(currentAssigneeId == userId)">@fullName</option>
                    }
                </select>
            </div>

            <div class="col-md-4">
                <label for="progressInput" class="form-label fw-semibold">Tiến độ (%)</label>
                <input type="number" id="progressInput" name="progress_percentage" class="form-control" min="0" max="100" value="@progress" required />
            </div>

            <div class="col-12 mt-5">
                <button type="submit" class="btn btn-primary btn-lg me-3">
                    <i class="bi bi-save me-2"></i> Lưu Thay đổi
                </button>
                <a href="@Url.Action("Index", "Tasks")" class="btn btn-outline-secondary btn-lg">
                    Quay lại
                </a>
            </div>
        </form>

    </div>
</div>
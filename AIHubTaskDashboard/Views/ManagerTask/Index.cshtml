@using System.Text.Json
@model List<JsonElement>

@{
    ViewData["Title"] = "Task Management";
    var tasks = Model;
    var users = (List<JsonElement>)ViewBag.Users;
}

<style>
    .task-card {
        border: 1px solid #ccc;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }

    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .task-status {
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 3px;
    }

    .status-InProgress {
        background-color: #ffc107;
        color: #333;
    }

    .status-Todo {
        background-color: #17a2b8;
        color: white;
    }

    .status-Done {
        background-color: #28a745;
        color: white;
    }

    .filter-container {
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    .btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-warning {
        background-color: #ffc107;
        color: #333;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }
</style>

<h1>Task Management</h1>
<p>
    <button class="btn btn-primary" onclick="openCreateModal()">➕ Create Task</button>
</p>

<!-- Filter -->
<div class="filter-container">
    <label>Status:</label>
    <select id="status-filter" onchange="filterTasks()">
        <option value="">-- All --</option>
        <option value="Todo">Todo</option>
        <option value="InProgress">In Progress</option>
        <option value="Done">Done</option>
    </select>

    <label style="margin-left: 20px;">Assignee:</label>
    <select id="assignee-filter" onchange="filterTasks()">
        <option value="">-- All --</option>
        @foreach (var user in users)
        {
            <option value="@user.GetProperty("id")">@user.GetProperty("name")</option>
        }
    </select>
</div>

<!-- Task List -->
<div id="task-list">
    @foreach (var task in tasks)
    {
        var assigneeId = task.GetProperty("assignee_id").GetInt32();
        var assigneeName = users.FirstOrDefault(u => u.GetProperty("id").GetInt32() == assigneeId).GetProperty("name").GetString() ?? "-";
        var status = task.GetProperty("status").GetString();
        var taskId = task.GetProperty("id").GetInt32();
        <div class="task-card" data-status="@status" data-assignee="@assigneeId" id="task-@taskId">
            <div class="task-header">
                <h3>@task.GetProperty("title") <small>(ID:@taskId)</small></h3>
                <span class="task-status status-@status">@status</span>
            </div>
            <p><strong>Assignee:</strong> @assigneeName</p>
            <p>@task.GetProperty("description")</p>
            <div>
                <button class="btn btn-warning" onclick="openEditModal(@taskId)">Edit</button>
            </div>
        </div>
    }
</div>

<!-- Create/Edit Modal -->
<div id="task-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:8px; width:400px;">
        <h3 id="modal-title">Create Task</h3>
        <form id="task-form">
            <input type="hidden" id="task-id">
            <div style="margin-bottom:10px;">
                <label>Title:</label>
                <input type="text" id="title" required style="width:100%; padding:5px;">
            </div>
            <div style="margin-bottom:10px;">
                <label>Description:</label>
                <textarea id="description" required style="width:100%; padding:5px;"></textarea>
            </div>
            <div style="margin-bottom:10px;">
                <label>Status:</label>
                <select id="status" style="width:100%; padding:5px;">
                    <option value="Todo">Todo</option>
                    <option value="InProgress">In Progress</option>
                    <option value="Done">Done</option>
                </select>
            </div>
            <div style="margin-bottom:10px;">
                <label>Assignee:</label>
                <select id="assignee" style="width:100%; padding:5px;">
                    @foreach (var user in users)
                    {
                        <option value="@user.GetProperty("id")">@user.GetProperty("name")</option>
                    }
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn" onclick="closeModal()">Cancel</button>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function openCreateModal() {
            $('#modal-title').text('Create Task');
            $('#task-id').val('');
            $('#title').val('');
            $('#description').val('');
            $('#status').val('Todo');
            $('#assignee').val('');
            $('#task-modal').css('display','flex');
        }

        function openEditModal(id) {
            var card = $('#task-' + id);
            $('#modal-title').text('Edit Task');
            $('#task-id').val(id);
            $('#title').val(card.find('h3').text().split('(ID:')[0].trim());
            $('#description').val(card.find('p').first().next().text());
            $('#status').val(card.data('status'));
            $('#assignee').val(card.data('assignee'));
            $('#task-modal').css('display','flex');
        }

        function closeModal() {
            $('#task-modal').hide();
        }

        $('#task-form').submit(function(e){
            e.preventDefault();
            var id = $('#task-id').val();
            var url = id ? '/ManagerTask/Update' : '/ManagerTask/Create';
            var data = {
                id: id,
                title: $('#title').val(),
                description: $('#description').val(),
                status: $('#status').val(),
                assignee_id: $('#assignee').val()
            };
            $.post(url, data, function(res){
                if(res.success){
                    location.reload();
                } else {
                    alert(res.message);
                }
            });
        });

        function filterTasks(){
            var status = $('#status-filter').val();
            var assignee = $('#assignee-filter').val();
            $('.task-card').each(function(){
                var show = true;
                if(status && $(this).data('status') != status) show = false;
                if(assignee && $(this).data('assignee') != assignee) show = false;
                $(this).toggle(show);
            });
        }
    </script>
}
